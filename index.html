<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø³Ø§Ø¨ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</title>
  <style>
    body {
      font-family: 'Tahoma', sans-serif;
      background-color: #f9fafb;
      padding: 20px;
    }
    h2, h3 {
      text-align: center;
      color: #1f2937;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: #ffffff;
      padding: 10px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }
    input[type="number"], input[type="text"] {
width:20%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 5px;
    }
    .entry {
      background: #f1f5f9;
      padding: 10px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .checkbox-group label {
      background-color: #e0f2fe;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid #bae6fd;
    }
    .select-all {
      background-color: #fde68a !important;
    }
    button {
      padding: 10px;
      background-color: #0284c7;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word;
      font-size: 0.9em;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px;
      text-align: center;
      font-size: 0.85em;
    }
    .positive { color: green; }
    .negative { color: red; }
  </style>
</head>
<body>
  <h2>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø³Ø§Ø¨ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h2>
  <div class="container">
    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡: 
<input type="number" id="friendCountInput" min="1" onchange="setFriendCount()" />
    </label>
    <div id="friendNames"></div>
    <div id="inputs"></div>
    <button onclick="addExpense()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
    <button onclick="clearAllExpenses()">ğŸ§¹ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>

    <div style="margin-top:10px">
      <button onclick="copyAll()">Ù†Ø³Ø®</button>
      <button onclick="importFromPastedText()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ù†Øµ Ù…Ù†Ø³ÙˆØ®</button>
      <button onclick="downloadData()">ØªØ­Ù…ÙŠÙ„</button>
      <input type="file" onchange="uploadData(event)" />
    </div>

    <h3>Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚</h3>
    <table id="summary"></table>

    <h3>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
    <table id="operations"></table>
  </div>

  <script>
    let friendCount = 3;
    let expenses = [];
    let friendNames = [];

    function saveToLocal() {
      localStorage.setItem("expenses", JSON.stringify(expenses));
      localStorage.setItem("friendNames", JSON.stringify(friendNames));
    }

    function loadFromLocal() {
      expenses = JSON.parse(localStorage.getItem("expenses") || "[]");
      friendNames = JSON.parse(localStorage.getItem("friendNames") || "[]");
    }

    function setFriendCount(optionalCount) {
  friendCount = optionalCount !== undefined 
    ? optionalCount 
    : parseInt(document.getElementById('friendCountInput').value);

  if (friendNames.length < friendCount) {
    for (let i = friendNames.length; i < friendCount; i++) {
      friendNames.push("Øµ" + (i + 1));
    }
  } else {
    friendNames = friendNames.slice(0, friendCount);
  }

  saveToLocal();
      friendCount = parseInt(document.getElementById('friendCountInput').value);
      if (friendNames.length < friendCount) {
        for (let i = friendNames.length; i < friendCount; i++) {
          friendNames.push("Øµ" + (i + 1));
        }
      } else {
        friendNames = friendNames.slice(0, friendCount);
      }
      saveToLocal();
      createFriendNameInputs();
      createInputs();
      renderSummary();
      renderOperations();
    }

    function createFriendNameInputs() {
      const div = document.getElementById('friendNames');
      div.innerHTML = '';
      for (let i = 0; i < friendCount; i++) {
        const input = document.createElement('input');
        input.type = "text";
        input.value = friendNames[i] || "Øµ" + (i + 1);
        input.oninput = () => {
          friendNames[i] = input.value;
          saveToLocal();
          renderSummary();
          renderOperations();
        };
        div.appendChild(input);
      }
    }

    function createInputs() {
      const inputsDiv = document.getElementById('inputs');
      inputsDiv.innerHTML = '';
      for (let i = 0; i < friendCount; i++) {
        const entry = document.createElement('div');
        entry.className = 'entry';
        entry.innerHTML = `
          <label>${friendNames[i]} ØµØ±Ù: <input type="number" id="amount${i}" /></label>
          <label>Ø¨ÙŠØ§Ù†: <input type="text" id="note${i}" /></label>
          <div class="checkbox-group">
            <label class="select-all"><input type="checkbox" onclick="selectAll(this, ${i})" /> Ø§Ù„Ø¬Ù…ÙŠØ¹</label>
            ${Array.from({ length: friendCount }, (_, j) => `
              <label><input type="checkbox" id="used${i}_${j}" /> ${friendNames[j]}</label>
            `).join('')}
          </div>
        `;
        inputsDiv.appendChild(entry);
      }
    }

    function selectAll(box, i) {
      for (let j = 0; j < friendCount; j++) {
        document.getElementById(`used${i}_${j}`).checked = box.checked;
      }
    }

    function addExpense() {
      const now = new Date().toLocaleString();
      for (let i = 0; i < friendCount; i++) {
        const amount = parseFloat(document.getElementById(`amount${i}`).value);
        const note = document.getElementById(`note${i}`).value;
        if (!isNaN(amount) && amount > 0) {
          const used = [];
          for (let j = 0; j < friendCount; j++) {
            if (document.getElementById(`used${i}_${j}`).checked) used.push(j);
          }
          if (used.length === 0) continue;
          expenses.push({ payer: i, amount, used, note, time: now });
        }
      }
      saveToLocal();
      createInputs();
      renderSummary();
      renderOperations();
    }

    function renderSummary() {
      const results = Array(friendCount).fill(0);
      const totals = Array(friendCount).fill(0);
      for (const exp of expenses) {
        const share = exp.amount / exp.used.length;
        for (const u of exp.used) results[u] -= share;
        results[exp.payer] += exp.amount;
        totals[exp.payer] += exp.amount;
      }
      const table = document.getElementById('summary');
      table.innerHTML = '<tr><th>Ø§Ù„ØµØ¯ÙŠÙ‚</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§ ØµØ±Ù</th></tr>';
      for (let i = 0; i < friendCount; i++) {
        table.innerHTML += `<tr>
          <td>${friendNames[i]}</td>
          <td class="${results[i] >= 0 ? 'positive' : 'negative'}">${results[i].toFixed(2)}</td>
          <td>${totals[i].toFixed(2)}</td>
        </tr>`;
      }
    }

    function renderOperations() {
      const table = document.getElementById('operations');
      table.innerHTML = '<tr><th>Ø§Ù„ØµØ¯ÙŠÙ‚</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø°Ù</th></tr>';
      expenses.forEach((e, idx) => {
        const usedStr = e.used.map(i => friendNames[i]).join(', ');
        table.innerHTML += `<tr>
          <td>${friendNames[e.payer]}</td>
          <td>${e.amount.toFixed(2)}</td>
          <td>${usedStr}</td>
          <td>${e.note}</td>
          <td>${e.time}</td>
          <td><button onclick="deleteExpense(${idx})">ğŸ—‘ï¸</button></td>
        </tr>`;
      });
    }

    function deleteExpense(index) {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) {
        expenses.splice(index, 1);
        saveToLocal();
        renderSummary();
        renderOperations();
      }
    }

    function clearAllExpenses() {
      if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŸ")) {
        expenses = [];
        saveToLocal();
        renderSummary();
        renderOperations();
      }
    }

    function copyAll() {
      const summary = document.getElementById('summary').innerText;
      const ops = document.getElementById('operations').innerText;
      const jsonData = JSON.stringify({ expenses, friendNames });
      const fullText = summary + '\n\n' + ops + '\n\n[DATA_START]' + jsonData + '[DATA_END]';

      const textarea = document.createElement('textarea');
      textarea.value = fullText;
      textarea.style.position = 'fixed';
      textarea.style.top = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®');
    }

    async function importFromPastedText() {
      try {
        const text = await navigator.clipboard.readText();
        if (!text || !text.includes('[DATA_START]')) throw new Error("No data found");
        processImportedText(text);
      } catch (err) {
        alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø§ÙØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.\n\nÙŠØ¬Ø¨ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø°ÙŠ Ø­ÙØ¸Øª Ø§Ù„Ù†Øµ ÙÙŠÙ‡.\n\nÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£Ø¯Ù†Ø§Ù‡.");
        const fallbackText = prompt("Ø£Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡ Ù…Ù† Ù‚Ø¨Ù„:");
        if (fallbackText) {
          processImportedText(fallbackText);
        }
      }
    }

    function processImportedText(input) {
      const match = input.match(/\[DATA_START](.*?)\[DATA_END]/s);
      if (match) {
        try {
          const data = JSON.parse(match[1]);
          expenses = data.expenses || [];
          friendNames = data.friendNames || [];
          friendCount = friendNames.length;
          document.getElementById('friendCountInput').value = friendCount;
          saveToLocal();
          setFriendCount();
          alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
        } catch {
          alert("âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
      } else {
        alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ");
      }
    }

    function downloadData() {
      const blob = new Blob([JSON.stringify({ expenses, friendNames })], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'expenses.json';
      a.click();
    }

    function uploadData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          expenses = data.expenses || [];
          friendNames = data.friendNames || [];
          friendCount = friendNames.length;
          document.getElementById('friendCountInput').value = friendCount;
          saveToLocal();
          setFriendCount();
        } catch {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
        }
      };
      reader.readAsText(file);
    }

   loadFromLocal();
const storedCount = friendNames.length > 0 ? friendNames.length : 3;
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('friendCountInput').value = storedCount;
  setFriendCount(storedCount);
});


  </script>
</body>
</html>
